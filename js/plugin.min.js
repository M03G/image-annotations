(function ($) {
	"use strict";

	$(function () {

		$('.comment-image').on('click', 'img', function (e) {
			$(".anotBox").remove();
			$($(this).parent()).css({"position":"relative"});
			var offset = $(this).offset();
			var relativeX = (e.pageX - offset.left);
			var relativeY = (e.pageY - offset.top);

			var ctope = offset.top + e.target.height + 10;
			var cleft = offset.left;
			var display = 'block';

			if (relativeX < 16) {
				relativeX = 16;
			}
			if (relativeX > (e.target.width - 16)) {
				relativeX = e.target.width - 16;
			}
			if (relativeY < 16) {
				relativeY = 16;
			}
			if (relativeY > (e.target.height - 16)) {
				relativeY = e.target.height - 16;
			}
			

			// console.log(e);
			// console.log("left absolute - " + offset.left + ". Top absolute - " + offset.top);
			// console.log("left - " + e.pageX + ". Top - " + e.pageY);
			// console.log("left in image - " + relativeX + ". Top in image - " + relativeY);
			// console.log("Height img - " + e.target.height + ". Offset width - " + e.target.width);

			var htmlArr = [];
			htmlArr.push('<div class="anotBox" style="width:30px;height:30px;border:1px solid #000000;z-index:10;border-radius:15px;position:absolute;left:' + (relativeX - 15) + 'px;top:' + (relativeY - 15) + 'px;"></div>');
			// if (!$("div").is(".anotText")){

			// 	// htmlArr.push('<div class="anotText" style="border:1px solid #000000;background:#ffffff;height:100px;width:' + e.target.width + 'px;position:absolute;left:' + (offset.left) + 'px;top:' + (offset.top + e.target.height + 30) + 'px;">');
			// 	// htmlArr.push('<textarea id="commImage" placeholder="Комментарий к изображению."></textarea><button class="cancelComm" type="cancel">cancel</button><button class="okComm">ok</button>')
			// 	// htmlArr.push('</div>');
			// }


			// console.log($(".anotText"));

			if ($(".anotText").css("display") == 'none') {

				display = 'block';

				// if ($("#commImage") && $("#commImage").value !=)
				console.log("!!");
				
			}

			$(".anotText").css({"display":display,"top":ctope + "px", "left":cleft+"px", "width":e.target.width + "px"})

			
			$($(this).parent()).after($(".anotText"));

			var ans = htmlArr.join('');

			$($(this)).after(ans);

			$(".anotBox").draggable({ containment:$(this), scroll:false });
			$(".anotBox").resizable({
				handles:"se",
				aspectRatio:true,
				minHeight: 30,
  				minWidth: 30
			});
		});
		$('body').on('click', '.cancelComm', function (e) {
			console.log("Click Cancel!");
			$(".anotBox").remove();
			$(".anotText").css({"display":"none"});
		});
		$('body').on('click', '.okComm', function (e) {
			console.log("Click ok!");
			var text = document.getElementById("commImage").value;
			if (text != "") {
				$.get("/wp-content/plugins/note-on-the-image/accept_ajax.php",{
					ph:text
				}, otpro)
			} else {
				console.log("empty .commImage");
			}
		});
		function otpro(){
			console.log("func ok");
		}

	});

}(jQuery));
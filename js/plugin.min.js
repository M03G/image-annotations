(function ($) {
	"use strict";

	$(function () {
		function killanot(){
			// Удалить выделение и скрыть поле ввода комментария
			$(".anotBox").remove();
			$(".anotText").css({"display":"none"});
		}

		$('.comment-image').on('click', 'img', function (e) {
			
			$(".anotBox").remove();
			$($(this).parent()).css({"position":"relative"});

			var offset = $(this).offset();

			var relativeX = (e.pageX - offset.left);
			var relativeY = (e.pageY - offset.top);
			// получаем точку клика мышкой по картинке. Если какая-то координата находится в районе 15 пикселей от границы изображения
			// меняем значение на +-16, дабы поле не выходило за границу изображения
			if (relativeX < 16) {
				relativeX = 16;
			}
			if (relativeX > (e.target.width - 16)) {
				relativeX = e.target.width - 16;
			}
			if (relativeY < 16) {
				relativeY = 16;
			}
			if (relativeY > (e.target.height - 16)) {
				relativeY = e.target.height - 16;
			}
			
			// позиция поля для комментария
			var ctope = offset.top + e.target.height + 10;
			var cleft = offset.left;

			var display = 'block';

			// console.log(e);
			// console.log("left absolute - " + offset.left + ". Top absolute - " + offset.top);
			// console.log("left - " + e.pageX + ". Top - " + e.pageY);
			// console.log("left in image - " + relativeX + ". Top in image - " + relativeY);
			// console.log("Height img - " + e.target.height + ". Offset width - " + e.target.width);

			if ($(".anotText").css("display") == 'none') {
				display = 'block';				
			}

			$(".anotText").css({"display":display,"top":ctope + "px", "left":cleft+"px"})
			
			console.log($($(this).closest('.kostyl')).is('.kostyl'));
			if ($($(this).closest('.kostyl')).is('.kostyl')) {
				$($(this).closest('.kostyl')).after($(".anotText"));
			} else {
				$($(this).closest('.comment-image')).after($(".anotText"));
			}

			// Добавление поля выделения
			$($(this)).after('<div class="anotBox"></div>');
			// Установка его под курсор
			$(".anotBox").css({"top":(relativeY - 15) + "px", "left":(relativeX - 15) + "px", "position":"absolute"})
			// Добавить возможность перемещения в пределах изображения
			$(".anotBox").draggable({ containment:$(this), scroll:false });
			// Добавить возможность изменения размера. Пропорционально. Без вомзможности сделать меньше значений по умолчанию.
			$(".anotBox").resizable({
				containment: $(this),
				handles: "se",
				// aspectRatio: true,
				minHeight: 30,
  				minWidth: 30
			});
		});
		$('.kostyl').on('click', '.area-vis-switch', function (e) {
			var vis = $(this).attr("vis");
			if (vis == 'on') {
				$($(this).closest(".kostyl")).children(".coi-area").css("display", "none");
				$(this).attr("vis", "off");
				$(this).removeClass("hide");
				$(this).addClass("show");
			} else {
				$($(this).closest(".kostyl")).children(".coi-area").css("display", "block");
				$(this).attr("vis", "on");
				$(this).removeClass("show");
				$(this).addClass("hide");
			}
		});
		$('.kostyl').on('click', '.comm-vis-switch', function (e) {
			var vis = $(this).attr("vis");
			if (vis == 'on') {
				$($(this).closest(".comment-content")).children(".comm_on_in").css("display", "none");
				$(this).attr("vis", "off");
				$(this).removeClass("hide");
				$(this).addClass("show");
			} else {
				$($(this).closest(".comment-content")).children(".comm_on_in").css("display", "block");
				$(this).attr("vis", "on");
				$(this).removeClass("show");
				$(this).addClass("hide");
			}
		});
		$('body').on('click', '.cancelComm', function (e) {
			console.log("Click Cancel!");
			// при нажатии на кнопку Cancel, удаляем поле на картинке
			killanot();
		});
		$('body').on('click', '.okComm', function (e) {
			

			// получаем данные для отправки комментария:
			// текст комментария
			var text = document.getElementById("commImage").value;
			// позицию и размер поля отметки
			var box = $(".anotBox");
			var top = box.position().top;
			var left = box.position().left;
			var sidew = box.width();
			var sideh = box.height();
			// номер комментария(с картинкой) на странице, для которой добавляется новый комментария
			var img = box.closest('article').attr('id');
			// защитный механизм (http://codex.wordpress.org/WordPress_Nonces)
			var nonce = $(this).attr('nonce');

			// console.log();

			if (text != "") {
				var time = new Date();
				$.post(
					"/wp-admin/admin-ajax.php",
					{
						action: "add_comm_on_i",
						text: text,
						top: top,
						left: left,
						sidew: sidew,
						sideh: sideh,
						img: img,
						nonce: nonce,
						usertime: time.toLocaleString()
					}, 
					otpro
				);
			} else {
				console.log("empty .commImage");
			}
		});
		$('.coi-text').on('click', '.ia-del-comm', function (e) {
			var delid = $(this).closest('.coi-text').attr('coi-id');
			var commimg = $(this).closest('article').attr('id');
			// защитный механизм (http://codex.wordpress.org/WordPress_Nonces)
			var nonce = $(this).attr('nonce');
			$.post(
				"/wp-admin/admin-ajax.php",
				{
					action: "del_ai_text",
					delid: delid,
					commimg: commimg,
					nonce: nonce
				}, 
				sdel
			);
			
		});
		// подсветка выделения и комментария при наведении
		$('.coi').hover(			
			function(){
				var coiid = $(this).attr("coi-id");
				$('[coi-id = ' + coiid + ']').addClass("hovered");
			},
			function(){
				var coiid = $(this).attr("coi-id");
				$('[coi-id = ' + coiid + ']').removeClass("hovered");
			}
		);
		function otpro(){
			console.log("func ok");
			$("#commImage").val("");
			killanot();
			location.reload();
		}
		function sdel(){
			console.log("del");
			location.reload();
		}
		$(document).keyup(function(e){
			if(e.keyCode==27 && $(".anotBox").is(":visible")){
				killanot();
				return false;
			}
		});

	});

}(jQuery));